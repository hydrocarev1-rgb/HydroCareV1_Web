<!DOCTYPE html>
<html lang="id">

<head>
    <title>HydroCare V1 | Smart Greenhouse Systems</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-sidebar: #ffffff;
            --bg-body: #f4f7fe;
            --sidebar-width: 280px;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        body { 
            background-color: var(--bg-body); 
            color: #1e293b; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
        }

        #auth-container { 
            min-height: 100vh; display: flex; align-items: center; justify-content: center; 
            background: radial-gradient(circle at top right, #6366f1, #4f46e5); 
            position: fixed; width: 100%; z-index: 9999; top: 0; left: 0; 
        }
        .auth-card { 
            background: rgba(255, 255, 255, 0.95); padding: 3.5rem 2.5rem; border-radius: 30px; width: 90%; max-width: 420px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); backdrop-filter: blur(10px);
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            background: var(--bg-sidebar);
            border-right: 1px solid #e2e8f0;
            padding: 2rem 1.2rem;
            z-index: 100;
        }

        .sidebar-brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 3rem;
            padding-left: 1rem;
            display: flex; align-items: center; gap: 12px;
        }

        .nav-link {
            display: flex; align-items: center;
            padding: 12px 18px;
            color: #8e9abb;
            text-decoration: none;
            border-radius: 16px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .nav-link:hover { background: #f8fafc; color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }
        .nav-link i { font-size: 1.1rem; width: 28px; }

        .main-content { margin-left: var(--sidebar-width); padding: 2.5rem; transition: 0.3s; }
        .content-section { display: none; animation: fadeIn 0.4s ease-out; }
        .content-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stat-card-v2 {
            background: white; border-radius: 24px; padding: 1.5rem;
            border: none; box-shadow: var(--card-shadow); height: 100%;
            transition: transform 0.3s ease;
        }
        .stat-card-v2:hover { transform: translateY(-5px); }

        .glass-header {
            background: rgba(244, 247, 254, 0.7);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 90;
            padding-bottom: 1rem;
        }

        .badge-mode {
            padding: 8px 16px; border-radius: 12px;
            font-size: 0.7rem; font-weight: 800; letter-spacing: 1px;
        }

        .btn-relay { 
            width: 100%; padding: 18px; border-radius: 20px; border: 1px solid #f1f5f9; 
            background: #fff; font-weight: 700; transition: 0.3s;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--card-shadow);
        }
        .btn-relay.active-on { background: var(--primary); color: white; border-color: var(--primary); }

        .table-custom { background: white; border-radius: 20px; overflow: hidden; box-shadow: var(--card-shadow); }
        .table-custom thead { background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .table-custom th { padding: 1.2rem; font-weight: 700; color: #64748b; font-size: 0.85rem; }
        .table-custom td { padding: 1.2rem; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }

        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>

<body>

    <div id="auth-container">
        <div class="auth-card text-center">
            <div class="mb-4">
                <div class="bg-primary text-white d-inline-block p-3 rounded-4 mb-3 shadow">
                    <i class="fas fa-leaf fa-2x"></i>
                </div>
                <h3 class="fw-800" style="color: #1e293b">HydroCare <span class="text-primary">V1</span></h3>
                <p class="text-muted small">Silahkan masuk untuk memantau sistem</p>
            </div>
            <div class="mb-3">
                <input type="email" id="loginEmail" class="form-control form-control-lg border-0 bg-light rounded-4" placeholder="Email">
            </div>
            <div class="mb-4">
                <input type="password" id="loginPass" class="form-control form-control-lg border-0 bg-light rounded-4" placeholder="Password">
            </div>
            <button id="btnLogin" class="btn btn-primary w-100 fw-bold py-3 rounded-4 shadow-lg border-0">
                SIGN IN
            </button>
        </div>
    </div>

    <div id="main-dashboard" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-droplet"></i> HYDROCARE
            </div>
            
            <div class="small fw-bold text-muted mb-3 ps-3" style="font-size: 11px; letter-spacing: 1.5px;">MENU UTAMA</div>
            <nav id="nav-menu">
                <a href="#" class="nav-link active" data-section="section-dashboard"><i class="fas fa-grid-2"></i> Dashboard</a>
                <a href="#" class="nav-link" data-section="section-sensor"><i class="fas fa-chart-line"></i> Data Sensor</a>
                <a href="#" class="nav-link" data-section="section-log"><i class="fas fa-list-ul"></i> Log Aktivitas</a>
                <a href="#" class="nav-link" data-section="section-report"><i class="fas fa-file-invoice"></i> Laporan</a>
                
                <div class="small fw-bold text-muted mt-5 mb-3 ps-3" style="font-size: 11px; letter-spacing: 1.5px;">PENGATURAN</div>
                <a href="#" class="nav-link" data-section="section-profile"><i class="fas fa-user-circle"></i> Profil User</a>
                <a href="#" class="nav-link text-danger" id="btnLogout"><i class="fas fa-power-off"></i> Keluar</a>
            </nav>
        </div>

        <div class="main-content">
            <div class="glass-header d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-800 mb-1" id="page-title">Dashboard Overview</h3>
                    <p class="text-muted small mb-0"><i class="far fa-calendar-alt me-2"></i><span id="current-time"></span></p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span id="modeStatus" class="badge-mode bg-white shadow-sm border">MODE: --</span>
                    <div class="d-flex align-items-center gap-3 bg-white p-2 pe-3 rounded-pill shadow-sm">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" class="rounded-circle" width="35">
                        <div class="fw-bold small" id="user-display-name">ADMIN</div>
                    </div>
                </div>
            </div>

            <div id="section-dashboard" class="content-section active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card-v2">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">TEMPERATUR</span>
                                <i class="fas fa-temperature-high text-danger"></i>
                            </div>
                            <h2 class="fw-800 mb-2"><span id="temp">0</span>°C</h2>
                            <div style="height: 60px;"><canvas id="cTemp"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-v2">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">KELEMBAPAN</span>
                                <i class="fas fa-droplet text-primary"></i>
                            </div>
                            <h2 class="fw-800 mb-2"><span id="hum">0</span>%</h2>
                            <div style="height: 60px;"><canvas id="cHum"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-v2">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">pH AIR</span>
                                <i class="fas fa-flask text-success"></i>
                            </div>
                            <h2 class="fw-800 mb-2" id="ph">0.0</h2>
                            <div style="height: 60px;"><canvas id="cPh"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-v2">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">TDS NUTRISI</span>
                                <i class="fas fa-seedling text-warning"></i>
                            </div>
                            <h2 class="fw-800 mb-2"><span id="tds">0</span> <small class="fs-6 text-muted">ppm</small></h2>
                            <div style="height: 60px;"><canvas id="cTds"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="stat-card-v2 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="fw-800 mb-0"><i class="fas fa-box-tissue me-2 text-primary"></i>Kapasitas Tangki Nutrisi</h6>
                                <span id="waterStatus" class="badge rounded-pill bg-success" style="font-size: 10px;">NORMAL</span>
                            </div>
                            <div class="row align-items-center">
                                <div class="col-md-4 text-center border-end">
                                    <h1 class="fw-800 text-primary mb-0" id="waterL">0.0</h1>
                                    <p class="small fw-bold text-muted">Liter Tersisa</p>
                                </div>
                                <div class="col-md-8 ps-md-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="small fw-bold">Level Air</span>
                                        <span class="small fw-bold text-primary" id="waterPct">0%</span>
                                    </div>
                                    <div class="progress" style="height: 12px; border-radius: 20px; background: #f1f5f9;">
                                        <div id="waterBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card-v2">
                            <h6 class="fw-800 mb-4"><i class="fas fa-cog me-2 text-primary"></i>Parameter Konfigurasi Sistem</h6>
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <label class="small fw-bold mb-2 text-muted">Sistem Mode</label>
                                    <select id="mode" class="form-select border-0 bg-light rounded-3 shadow-none">
                                        <option value="Auto">Otomatis (AI Mode)</option>
                                        <option value="Manual">Manual (User Control)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-2 text-muted">Jadwal Pompa</label>
                                    <div class="input-group">
                                        <input type="time" id="on1" class="form-control border-0 bg-light">
                                        <span class="input-group-text border-0 bg-light text-muted">s/d</span>
                                        <input type="time" id="off1" class="form-control border-0 bg-light">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-2 text-muted">Jadwal Kipas</label>
                                    <div class="input-group">
                                        <input type="time" id="on2" class="form-control border-0 bg-light">
                                        <span class="input-group-text border-0 bg-light text-muted">s/d</span>
                                        <input type="time" id="off2" class="form-control border-0 bg-light">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="stat-card-v2 mb-4">
                            <h6 class="fw-800 mb-4">Hardware Control</h6>
                            <div class="d-grid gap-3">
                                <button id="btn1" class="btn-relay">
                                    <span class="d-flex align-items-center gap-3">
                                        <i class="fas fa-tint fs-4"></i>
                                        <span class="text-start">
                                            <span class="d-block fw-800">Pompa Air</span>
                                            <span class="small opacity-75">Status: Standby</span>
                                        </span>
                                    </span>
                                    <i class="fas fa-chevron-right opacity-50"></i>
                                </button>
                                <button id="btn2" class="btn-relay">
                                    <span class="d-flex align-items-center gap-3">
                                        <i class="fas fa-wind fs-4"></i>
                                        <span class="text-start">
                                            <span class="d-block fw-800">Exhaust Fan</span>
                                            <span class="small opacity-75">Status: Standby</span>
                                        </span>
                                    </span>
                                    <i class="fas fa-chevron-right opacity-50"></i>
                                </button>
                            </div>
                            <div class="mt-3 p-3 rounded-3 bg-light border">
                                <p class="small text-muted mb-0"><i class="fas fa-info-circle me-1"></i> Mode Manual harus diaktifkan untuk kontrol langsung.</p>
                            </div>
                        </div>

                        <div class="stat-card-v2 bg-dark text-white shadow-lg">
                            <h6 class="fw-800 mb-3">Ekspor Data Laporan</h6>
                            
                            <div class="mb-3">
                                <label class="small fw-bold mb-1 text-white-50">Refresh Rate (Interval Log)</label>
                                <select id="logInterval" class="form-select form-select-sm border-0 bg-secondary text-white rounded-3 shadow-none">
                                    <option value="60">Setiap 1 Jam (24 Data/Hari)</option>
                                    <option value="5">Setiap 5 Menit</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="small fw-bold mb-1 text-white-50">Pilih Tanggal</label>
                                <input type="date" id="downloadDate" class="form-control form-control-sm border-0 bg-secondary text-white rounded-3 shadow-none">
                            </div>
                            
                            <button id="btnDownload" class="btn btn-primary w-100 fw-bold py-3 rounded-3 border-0 mt-2">
                                <i class="fas fa-file-export me-2"></i> DOWNLOAD LAPORAN
                            </button>
                            <div id="dlStatus" class="mt-2 text-center text-primary small" style="display:none;">
                                <span class="spinner-border spinner-border-sm"></span> Menyiapkan Excel...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-sensor" class="content-section">
                <div class="stat-card-v2">
                    <h5 class="fw-800 mb-4">Real-time Sensor Monitoring</h5>
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr><th>Parameter</th><th>Value</th><th>Status</th><th>Unit</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>Temperatur</td><td id="table-temp">--</td><td><span class="badge bg-success">Optimal</span></td><td>Celsius</td></tr>
                                <tr><td>Kelembapan</td><td id="table-hum">--</td><td><span class="badge bg-success">Optimal</span></td><td>Percent</td></tr>
                                <tr><td>pH Air</td><td id="table-ph">--</td><td><span class="badge bg-warning">Warning</span></td><td>pH Scale</td></tr>
                                <tr><td>TDS Nutrisi</td><td id="table-tds">--</td><td><span class="badge bg-success">Optimal</span></td><td>PPM</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-log" class="content-section">
                <div class="stat-card-v2 text-center py-5">
                    <i class="fas fa-history fa-4x text-light mb-4"></i>
                    <h5 class="fw-800">Log Aktivitas Sistem</h5>
                    <p class="text-muted">Gunakan menu Ekspor Data untuk melihat riwayat lengkap.</p>
                </div>
            </div>

            <div id="section-report" class="content-section">
                <div class="stat-card-v2 text-center py-5">
                    <i class="fas fa-file-invoice fa-4x text-light mb-4"></i>
                    <h5 class="fw-800">Manajemen Laporan</h5>
                    <p class="text-muted">Laporan harian otomatis tersedia di dashboard utama.</p>
                </div>
            </div>
            
            <div id="section-profile" class="content-section">
                <div class="stat-card-v2 p-5 text-center">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" class="rounded-circle mb-4 shadow" width="120">
                    <h4 class="fw-800 mb-0" id="profile-name">Administrator</h4>
                    <p class="text-muted mb-4">Sistem Monitoring Greenhouse</p>
                    <button class="btn btn-outline-primary px-5 rounded-pill fw-bold">Edit Profil</button>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCscH1HT-y9QOeZ-nJtlu-suPMks5utEMw",
            authDomain: "hydrocarev1-85b81.firebaseapp.com",
            databaseURL: "https://hydrocarev1-85b81-default-rtdb.firebaseio.com",
            projectId: "hydrocarev1-85b81",
            storageBucket: "hydrocarev1-85b81.firebasestorage.app",
            messagingSenderId: "955201396609",
            appId: "1:955201396609:web:d37b3376d6f003b3ed5280"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const links = document.querySelectorAll('.nav-link[data-section]');
        const sections = document.querySelectorAll('.content-section');
        const pageTitle = document.getElementById('page-title');

        links.forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const target = link.getAttribute('data-section');
                links.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                sections.forEach(s => s.classList.remove('active'));
                document.getElementById(target).classList.add('active');
                pageTitle.innerText = link.innerText;
            };
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                const name = user.email.split('@')[0].toUpperCase();
                document.getElementById('user-display-name').innerText = name;
                document.getElementById('profile-name').innerText = name;
                startApp();
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('main-dashboard').style.display = 'none';
            }
        });

        document.getElementById('btnLogin').onclick = () => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            if(!e || !p) return alert("Isi email dan password!");
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("Gagal: " + err.message));
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);

        function startApp() {
            let r1, r2, modeActual;
            const up = (p, v) => set(ref(db, 'Greenhouse/' + p), v);

            function createChart(id, color) {
                return new Chart(document.getElementById(id), {
                    type: 'line',
                    data: { 
                        labels: Array(10).fill(''), 
                        datasets: [{ 
                            borderColor: color, borderWidth: 3,
                            data: Array(10).fill(0), tension: 0.4, 
                            fill: true, backgroundColor: color + '15', pointRadius: 0 
                        }] 
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { x: { display: false }, y: { display: false } } 
                    }
                });
            }

            const charts = { 
                t: createChart('cTemp', '#ef4444'), 
                h: createChart('cHum', '#6366f1'), 
                p: createChart('cPh', '#10b981'), 
                d: createChart('cTds', '#f59e0b')
            };

            onValue(ref(db, 'Greenhouse'), (snap) => {
                const d = snap.val(); if (!d) return;
                
                if (d.Sensor) {
                    const sensorData = [
                        { id: 'temp', val: d.Sensor.Temperatur },
                        { id: 'hum', val: d.Sensor.Kelembapan },
                        { id: 'ph', val: d.Sensor.pH ? d.Sensor.pH.toFixed(1) : "0.0" },
                        { id: 'tds', val: d.Sensor.TDS }
                    ];

                    sensorData.forEach(item => {
                        if(document.getElementById(item.id)) document.getElementById(item.id).innerText = item.val || 0;
                        if(document.getElementById('table-' + item.id)) document.getElementById('table-' + item.id).innerText = item.val || 0;
                    });

                    document.getElementById('waterL').innerText = d.Sensor.WaterLitres ? d.Sensor.WaterLitres.toFixed(1) : "0.0";
                    document.getElementById('waterPct').innerText = (d.Sensor.WaterLevel || 0) + "%";
                    document.getElementById('waterBar').style.width = (d.Sensor.WaterLevel || 0) + "%";
                    
                    const lvl = d.Sensor.WaterLevel || 0;
                    const wStatus = document.getElementById('waterStatus');
                    wStatus.innerText = lvl < 20 ? "KRITIS" : "NORMAL";
                    wStatus.className = lvl < 20 ? "badge bg-danger" : "badge bg-success";

                    const sV = [d.Sensor.Temperatur, d.Sensor.Kelembapan, d.Sensor.pH, d.Sensor.TDS];
                    Object.keys(charts).forEach((k, i) => {
                        charts[k].data.datasets[0].data.push(sV[i]);
                        charts[k].data.datasets[0].data.shift();
                        charts[k].update('none');
                    });
                }

                if (d.Control) {
                    modeActual = d.Control.Mode;
                    document.getElementById('mode').value = modeActual;
                    const ms = document.getElementById('modeStatus');
                    ms.innerText = "MODE: " + modeActual.toUpperCase();
                    ms.className = "badge-mode " + (modeActual === 'Auto' ? "bg-primary text-white" : "bg-warning text-dark shadow-sm");
                    
                    r1 = d.Control.ManualRelay1; r2 = d.Control.ManualRelay2;
                    document.getElementById('on1').value = d.Control.OnR1 || "00:00";
                    document.getElementById('off1').value = d.Control.OffR1 || "00:00";
                    document.getElementById('on2').value = d.Control.OnR2 || "00:00";
                    document.getElementById('off2').value = d.Control.OffR2 || "00:00";
                    document.getElementById('logInterval').value = d.Control.LogInterval || 5;
                }

                if (d.Status) {
                    const updateRelayUI = (id, status) => {
                        const btn = document.getElementById(id);
                        btn.className = (status === 1) ? "btn-relay active-on" : "btn-relay";
                        btn.querySelector('.small').innerText = (status === 1) ? "Status: AKTIF" : "Status: STANDBY";
                    };
                    updateRelayUI('btn1', d.Status.Relay1);
                    updateRelayUI('btn2', d.Status.Relay2);
                }
            });

            ['on1','off1','on2','off2','mode','logInterval'].forEach(id => {
                document.getElementById(id).onchange = (e) => {
                    let v = e.target.value;
                    let path = 'Control/' + id.charAt(0).toUpperCase() + id.slice(1);
                    if(id.includes('1') || id.includes('2')) path = 'Control/' + id.charAt(0).toUpperCase() + id.slice(1).toUpperCase();
                    if(id === 'logInterval') v = parseInt(v);
                    up(path, v);
                };
            });

            document.getElementById('btn1').onclick = () => modeActual === 'Manual' ? up('Control/ManualRelay1', r1 === 1 ? 0 : 1) : alert("Ubah ke Mode Manual");
            document.getElementById('btn2').onclick = () => modeActual === 'Manual' ? up('Control/ManualRelay2', r2 === 1 ? 0 : 1) : alert("Ubah ke Mode Manual");

            // --- DOWNLOAD LOGIC: FILTER 1 JAM SEKALI ---
            document.getElementById('btnDownload').onclick = async () => {
                const dateVal = document.getElementById('downloadDate').value;
                const intervalVal = document.getElementById('logInterval').value;
                
                if (!dateVal) return alert("Pilih tanggal laporan!");

                const [year, month, day] = dateVal.split('-');
                const statusEl = document.getElementById('dlStatus');
                statusEl.style.display = 'block';

                try {
                    const logPath = `Greenhouse/LogExcel/${year}/${month}/${day}`;
                    const snap = await get(ref(db, logPath));
                    const data = snap.val();

                    if (!data) {
                        alert(`Data log untuk tanggal ${day}-${month}-${year} tidak ditemukan.`);
                        return;
                    }

                    const rows = [["Waktu", "Suhu (°C)", "Lembap (%)", "pH Air", "TDS (PPM)", "Water (%)", "Relay 1", "Relay 2"]];
                    
                    const rawData = Object.values(data);
                    const filteredData = [];
                    const seenHours = new Set();

                    // LOGIKA FILTER: Jika interval 1 jam (60 menit), hanya ambil data pertama setiap jamnya
                    rawData.forEach(item => {
                        if (intervalVal == "60") {
                            const hour = item.Waktu.split(':')[0]; // Mengambil HH dari "HH:mm:ss"
                            if (!seenHours.has(hour)) {
                                filteredData.push(item);
                                seenHours.add(hour);
                            }
                        } else {
                            filteredData.push(item);
                        }
                    });

                    filteredData.forEach(i => {
                        rows.push([i.Waktu, i.Suhu_C, i.Lembap_Persen, i.pH_Air, i.TDS_PPM, i.Water_Pct, i.Relay1, i.Relay2]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Log Sensor");
                    XLSX.writeFile(wb, `HydroCare_Report_${day}_${month}_${year}.xlsx`);
                } catch(e) { 
                    console.error(e);
                    alert("Error saat mengambil data.");
                } finally {
                    statusEl.style.display = 'none';
                }
            };

            document.getElementById('downloadDate').valueAsDate = new Date();

            setInterval(() => {
                document.getElementById('current-time').innerText = new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' }) + " WIB";
            }, 1000);
        }
    </script>
</body>
</html>