<!DOCTYPE html>
<html lang="id">

<head>
    <title>HydroCare V1 | Smart Greenhouse Systems</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5E50F9;
            --primary-light: #F0EEFF;
            --primary-dark: #4a3fdc;
            --bg-sidebar: #ffffff;
            --bg-body: #f6f8fd;
            --sidebar-width: 280px;
            --card-shadow: 0 8px 24px rgba(29, 41, 59, 0.07);
            --border-color: #e9eef5;
        }

        body { 
            background-color: var(--bg-body); 
            color: #334155; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
        }

        #auth-container { 
            min-height: 100vh; display: flex; align-items: center; justify-content: center; 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            position: fixed; width: 100%; z-index: 9999; top: 0; left: 0; 
        }
        .auth-card { 
            background: rgba(255, 255, 255, 0.98); padding: 3rem; border-radius: 24px; width: 90%; max-width: 450px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .auth-icon {
            background: var(--primary);
            color: white;
            height: 70px;
            width: 70px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 24px;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 20px -5px rgba(94, 80, 249, 0.5);
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1.2rem;
            z-index: 100;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 3rem;
            padding-left: 1rem;
            display: flex; align-items: center; gap: 12px;
        }
        .sidebar-brand i { color: var(--primary); }

        .nav-link {
            display: flex; align-items: center;
            padding: 14px 20px;
            color: #64748b;
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .nav-link:hover { background: var(--primary-light); color: var(--primary); transform: translateX(5px); }
        .nav-link.active { background: var(--primary); color: white; box-shadow: 0 7px 15px -3px rgba(94, 80, 249, 0.4); transform: translateX(5px); }
        .nav-link i { font-size: 1.1rem; width: 28px; transition: transform 0.2s ease; }
        .nav-link:hover i { transform: scale(1.1); }

        .main-content { margin-left: var(--sidebar-width); padding: 2.5rem; transition: 0.3s; }
        .content-section { display: none; animation: fadeIn 0.4s ease-out; }
        .content-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stat-card-v2 {
            background: white; border-radius: 20px; padding: 1.75rem;
            border: 1px solid var(--border-color); box-shadow: none;
            transition: all 0.3s ease;
        }
        .stat-card-v2:hover { transform: translateY(-6px); box-shadow: var(--card-shadow); border-color: var(--primary); }

        .stat-icon {
            height: 48px;
            width: 48px;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .stat-icon.temp { background-color: #fff1f2; color: #ef4444; }
        .stat-icon.hum { background-color: #f0eefc; color: #6366f1; }
        .stat-icon.ph { background-color: #ecfdf5; color: #10b981; }
        .stat-icon.tds { background-color: #fffbeb; color: #f59e0b; }

        .glass-header {
            background: rgba(246, 248, 253, 0.8);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 90;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .badge-mode {
            padding: 8px 16px; border-radius: 12px;
            font-size: 0.7rem; font-weight: 800; letter-spacing: 1px;
        }

        .btn-relay { 
            width: 100%; padding: 1rem; border-radius: 16px; border: 2px solid var(--border-color); 
            background: #fafbff; font-weight: 700; transition: 0.3s;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: none;
        }
        .btn-relay:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .btn-relay.active-on { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 7px 15px -5px rgba(94, 80, 249, 0.5); }
        .btn-relay .fs-4 {
            color: #94a3b8;
            transition: 0.3s;
        }
        .btn-relay:hover .fs-4 { color: var(--primary); }
        .btn-relay.active-on .fs-4 { color: white; }

        .table-custom { background: white; border-radius: 20px; overflow: hidden; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .table-custom thead { background: #f8fafc; border-bottom: 2px solid var(--border-color); }
        .table-custom th { padding: 1rem 1.5rem; font-weight: 700; color: #475569; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .table-custom td { padding: 1rem 1.5rem; vertical-align: middle; border-bottom: 1px solid var(--border-color); color: #475569; }
        .table-custom tbody tr:last-child td { border-bottom: none; }
        .table-custom tbody tr:hover { background-color: #f8fafc; }

        .card-accent {
            background: var(--primary);
            color: white;
        }
        .card-accent label {
            color: rgba(255,255,255,0.7);
        }
        .card-accent .form-control, .card-accent .form-select {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
        }
        .card-accent .form-control::placeholder { color: rgba(255,255,255,0.5); }
        .card-accent .btn-primary {
            background: white;
            color: var(--primary);
            border: none;
        }
        .card-accent .btn-primary:hover {
            background: #f0eefc;
            color: var(--primary);
        }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 99;
            display: none; backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); z-index: 1000; }
            .sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; padding: 1.2rem; }
            .glass-header { padding: 0.5rem 0; }
        }

        @media (max-width: 767.98px) {
            .table-responsive-stack {
                border: none !important;
                box-shadow: none !important;
                background: transparent !important;
            }
            .table-responsive-stack thead { display: none; }
            .table-responsive-stack tbody { display: block; width: 100%; }
            
            .table-responsive-stack tr {
                display: block;
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                overflow: hidden;
            }

            .table-responsive-stack td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.8rem 1.25rem;
                border-bottom: 1px solid #f1f5f9;
                font-size: 0.9rem;
                color: #334155;
            }
            
            .table-responsive-stack tr td:last-child { border-bottom: none; }
            
            .table-responsive-stack td::before { 
                content: attr(data-label); 
                font-weight: 700; 
                color: #94a3b8; 
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Header style for the first cell in the stack (Waktu / Parameter) */
            .table-responsive-stack td:first-child {
                background: #f8fafc;
                border-bottom: 1px solid #e2e8f0;
                font-weight: 800;
                color: var(--primary) !important;
                padding: 1rem 1.25rem;
            }
            
            .table-responsive-stack td:first-child::before {
                color: #64748b;
            }
        }
    </style>
</head>

<body>

    <div id="auth-container">
        <div class="auth-card text-center">
            <div class="mb-4">
                <div class="auth-icon">
                    <i class="fas fa-leaf fa-2x"></i>
                </div>
                <h3 class="fw-800" style="color: #1e293b">HydroCare <span class="text-primary">V1</span></h3>
                <p class="text-muted small">Silahkan masuk untuk memantau sistem</p>
            </div>
            <div class="mb-3">
                <input type="email" id="loginEmail" class="form-control form-control-lg border-0 bg-light rounded-4" placeholder="Email">
            </div>
            <div class="mb-4">
                <input type="password" id="loginPass" class="form-control form-control-lg border-0 bg-light rounded-4" placeholder="Password">
            </div>
            <button id="btnLogin" class="btn btn-primary w-100 fw-bold py-3 rounded-4 shadow-lg border-0">
                SIGN IN
            </button>
        </div>
    </div>

    <div id="main-dashboard" style="display: none;">
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <div class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-droplet"></i> HYDROCARE
            </div>
            
            <div class="small fw-bold text-muted mb-3 ps-3" style="font-size: 11px; letter-spacing: 1.5px;">MENU UTAMA</div>
            <nav id="nav-menu">
                <a href="#" class="nav-link active" data-section="section-dashboard"><i class="fas fa-grid-2"></i> Dashboard</a>
                <a href="#" class="nav-link" data-section="section-sensor"><i class="fas fa-chart-line"></i> Data Sensor</a>
                <a href="#" class="nav-link" data-section="section-log"><i class="fas fa-list-ul"></i> Log Aktivitas</a>
                <a href="#" class="nav-link" data-section="section-report"><i class="fas fa-file-invoice"></i> Laporan</a>
                
                <div class="small fw-bold text-muted mt-5 mb-3 ps-3" style="font-size: 11px; letter-spacing: 1.5px;">PENGATURAN</div>
                <a href="#" class="nav-link" data-section="section-profile"><i class="fas fa-user-circle"></i> Profil User</a>
                <a href="#" class="nav-link text-danger" id="btnLogout"><i class="fas fa-power-off"></i> Keluar</a>
            </nav>
        </div>

        <div class="main-content">
            <div class="glass-header mb-4">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
                    <div class="d-flex align-items-center gap-3">
                        <button id="sidebarToggle" class="btn btn-light bg-white border shadow-sm d-lg-none rounded-3 px-3"><i class="fas fa-bars"></i></button>
                        <div>
                            <h3 class="fw-800 mb-1" id="page-title">Dashboard </h3>
                            <p class="text-muted small mb-0"><i class="far fa-calendar-alt me-2"></i><span id="current-time"></span></p>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between gap-3">
                    <span id="modeStatus" class="badge-mode bg-white shadow-sm border">MODE: --</span>
                    <div class="d-flex align-items-center gap-3 bg-white p-2 pe-3 rounded-pill shadow-sm">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" class="rounded-circle" width="35">
                        <div class="fw-bold small" id="user-display-name">ADMIN</div>
                    </div>
                </div>
            </div>
            </div>

            <div id="section-dashboard" class="content-section active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card-v2 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">TEMPERATUR</span>
                                <div class="stat-icon temp"><i class="fas fa-temperature-high"></i></div>
                            </div>
                            <h2 class="fw-800 mb-2"><span id="temp">0</span>째C</h2>
                            <div style="height: 60px;"><canvas id="cTemp"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-v2 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">KELEMBAPAN</span>
                                <div class="stat-icon hum"><i class="fas fa-droplet"></i></div>
                            </div>
                            <h2 class="fw-800 mb-2"><span id="hum">0</span>%</h2>
                            <div style="height: 60px;"><canvas id="cHum"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-v2 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">pH AIR</span>
                                <div class="stat-icon ph"><i class="fas fa-flask"></i></div>
                            </div>
                            <h2 class="fw-800 mb-2" id="ph">0.0</h2>
                            <div style="height: 60px;"><canvas id="cPh"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-v2 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="text-muted small fw-bold">TDS NUTRISI</span>
                                <div class="stat-icon tds"><i class="fas fa-seedling"></i></div>
                            </div>
                            <h2 class="fw-800 mb-2"><span id="tds">0</span> <small class="fs-6 text-muted">ppm</small></h2>
                            <div style="height: 60px;"><canvas id="cTds"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="stat-card-v2 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="fw-800 mb-0"><i class="fas fa-box-tissue me-2 text-primary"></i>Kapasitas Tangki Nutrisi</h6>
                                <span id="waterStatus" class="badge rounded-pill bg-success" style="font-size: 10px;">NORMAL</span>
                            </div>
                            <div class="row align-items-center">
                                <div class="col-md-4 text-center border-end">
                                    <h1 class="fw-800 text-primary mb-0" id="waterL">0.0</h1>
                                    <p class="small fw-bold text-muted">Liter Tersisa</p>
                                </div>
                                <div class="col-md-8 ps-md-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="small fw-bold">Level Air</span>
                                        <span class="small fw-bold text-primary" id="waterPct">0%</span>
                                    </div>
                                    <div class="progress" style="height: 12px; border-radius: 20px; background: #f1f5f9;">
                                        <div id="waterBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card-v2">
                            <h6 class="fw-800 mb-4"><i class="fas fa-cog me-2 text-primary"></i>Parameter Konfigurasi Sistem</h6>
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <label class="small fw-bold mb-2 text-muted">Sistem Mode</label>
                                    <select id="mode" class="form-select border-0 bg-light rounded-3 shadow-none">
                                        <option value="Auto">Otomatis (AI Mode)</option>
                                        <option value="Manual">Manual (User Control)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-2 text-muted">Jadwal Pompa</label>
                                    <div class="input-group">
                                        <input type="time" id="on1" class="form-control border-0 bg-light">
                                        <span class="input-group-text border-0 bg-light text-muted">s/d</span>
                                        <input type="time" id="off1" class="form-control border-0 bg-light">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-2 text-muted">Jadwal Kipas</label>
                                    <div class="input-group">
                                        <input type="time" id="on2" class="form-control border-0 bg-light">
                                        <span class="input-group-text border-0 bg-light text-muted">s/d</span>
                                        <input type="time" id="off2" class="form-control border-0 bg-light">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card-v2 mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="fw-800 mb-0"><i class="fab fa-telegram-plane me-2 text-primary"></i> Notifikasi Peringatan Telegram</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="TeleActive">
                                    <label class="form-check-label" for="TeleActive">Aktifkan</label>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-2 text-muted">Token Bot Telegram</label>
                                    <input type="password" id="TeleToken" class="form-control border-0 bg-light" placeholder="Masukkan Token Bot">
                                </div>
                                <div class="col-md-6">
                                    <label class="small fw-bold mb-2 text-muted">Chat ID Telegram</label>
                                    <input type="text" id="TeleID" class="form-control border-0 bg-light" placeholder="Masukkan Chat ID">
                                </div>
                            </div>
                            <hr class="my-4">
                            <p class="small fw-bold text-muted mb-3">Batas Nilai Peringatan Sensor</p>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-2 text-muted">Suhu Maks. (째C)</label>
                                    <input type="number" id="LimitTemp" class="form-control border-0 bg-light">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-2 text-muted">Lembap Maks. (%)</label>
                                    <input type="number" id="LimitHum" class="form-control border-0 bg-light">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-2 text-muted">TDS Maks. (ppm)</label>
                                    <input type="number" id="LimitTds" class="form-control border-0 bg-light">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-2 text-muted">Air Min. (%)</label>
                                    <input type="number" id="LimitWaterMin" class="form-control border-0 bg-light">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-2 text-muted">pH Min.</label>
                                    <input type="number" step="0.1" id="LimitPhMin" class="form-control border-0 bg-light">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-2 text-muted">pH Maks.</label>
                                    <input type="number" step="0.1" id="LimitPhMax" class="form-control border-0 bg-light">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="stat-card-v2 mb-4">
                            <h6 class="fw-800 mb-4">Hardware Control</h6>
                            <div class="d-grid gap-3">
                                <button id="btn1" class="btn-relay">
                                    <span class="d-flex align-items-center gap-3">
                                        <i class="fas fa-tint fs-4"></i>
                                        <span class="text-start">
                                            <span class="d-block fw-800">Pompa Air</span>
                                            <span class="small opacity-75">Status: Standby</span>
                                        </span>
                                    </span>
                                    <i class="fas fa-chevron-right opacity-50"></i>
                                </button>
                                <button id="btn2" class="btn-relay">
                                    <span class="d-flex align-items-center gap-3">
                                        <i class="fas fa-wind fs-4"></i>
                                        <span class="text-start">
                                            <span class="d-block fw-800">Exhaust Fan</span>
                                            <span class="small opacity-75">Status: Standby</span>
                                        </span>
                                    </span>
                                    <i class="fas fa-chevron-right opacity-50"></i>
                                </button>
                            </div>
                            <div class="mt-3 p-3 rounded-3 bg-light border">
                                <p class="small text-muted mb-0"><i class="fas fa-info-circle me-1"></i> Mode Manual harus diaktifkan untuk kontrol langsung.</p>
                            </div>
                        </div>

                        <div class="stat-card-v2 card-accent shadow-lg">
                            <h6 class="fw-800 mb-3">Ekspor Data Laporan</h6>
                            
                            <div class="mb-3">
                                <label class="small fw-bold mb-1">Refresh Rate (Interval Log)</label>
                                <select id="logInterval" class="form-select form-select-sm rounded-3 shadow-none">
                                    <option value="60">Setiap 1 Jam (24 Data/Hari)</option>
                                    <option value="5">Setiap 5 Menit</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="small fw-bold mb-1">Pilih Tanggal</label>
                                <input type="date" id="downloadDate" class="form-control form-control-sm rounded-3 shadow-none">
                            </div>
                            
                            <button id="btnDownload" class="btn btn-primary w-100 fw-bold py-3 rounded-3 border-0 mt-2">
                                <i class="fas fa-file-export me-2"></i> DOWNLOAD LAPORAN
                            </button>
                            <div id="dlStatus" class="mt-2 text-center text-primary small" style="display:none;">
                                <span class="spinner-border spinner-border-sm"></span> Menyiapkan Excel...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-sensor" class="content-section">
                <div class="stat-card-v2">
                    <h5 class="fw-800 mb-4">Real-time Sensor Monitoring</h5>
                    <div class="table-responsive">
                        <table class="table table-custom table-responsive-stack">
                            <thead>
                                <tr><th>Parameter</th><th>Value</th><th>Status</th><th>Unit</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td data-label="Parameter">Temperatur</td>
                                    <td data-label="Value" id="table-temp">--</td>
                                    <td data-label="Status"><span class="badge bg-success">Optimal</span></td>
                                    <td data-label="Unit">Celsius</td>
                                </tr>
                                <tr>
                                    <td data-label="Parameter">Kelembapan</td>
                                    <td data-label="Value" id="table-hum">--</td>
                                    <td data-label="Status"><span class="badge bg-success">Optimal</span></td>
                                    <td data-label="Unit">Percent</td>
                                </tr>
                                <tr>
                                    <td data-label="Parameter">pH Air</td>
                                    <td data-label="Value" id="table-ph">--</td>
                                    <td data-label="Status"><span class="badge bg-warning">Warning</span></td>
                                    <td data-label="Unit">pH Scale</td>
                                </tr>
                                <tr>
                                    <td data-label="Parameter">TDS Nutrisi</td>
                                    <td data-label="Value" id="table-tds">--</td>
                                    <td data-label="Status"><span class="badge bg-success">Optimal</span></td>
                                    <td data-label="Unit">PPM</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-log" class="content-section">
                <div class="stat-card-v2">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-800 mb-0"><i class="fas fa-history me-2 text-primary"></i>Riwayat Aktivitas Terakhir</h5>
                        <button class="btn btn-sm btn-light rounded-pill px-3" onclick="location.reload()"><i class="fas fa-sync-alt me-1"></i> Refresh</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom table-responsive-stack">
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>Suhu</th>
                                    <th>Lembap</th>
                                    <th>pH Air</th>
                                    <th>TDS (PPM)</th>
                                    <th>Pompa</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">Memuat data log terbaru...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-report" class="content-section">
                <div class="stat-card-v2 text-center py-5">
                    <i class="fas fa-file-invoice fa-4x text-light mb-4"></i>
                    <h5 class="fw-800">Manajemen Laporan</h5>
                    <p class="text-muted">Laporan harian otomatis tersedia di dashboard utama.</p>
                </div>
            </div>
            
            <div id="section-profile" class="content-section">
                <div class="stat-card-v2 p-5 text-center">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" class="rounded-circle mb-4 shadow" width="120">
                    <h4 class="fw-800 mb-0" id="profile-name">Administrator</h4>
                    <p class="text-muted mb-4">Sistem Monitoring Greenhouse</p>
                    <button class="btn btn-outline-primary px-5 rounded-pill fw-bold">Edit Profil</button>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCscH1HT-y9QOeZ-nJtlu-suPMks5utEMw",
            authDomain: "hydrocarev1-85b81.firebaseapp.com",
            databaseURL: "https://hydrocarev1-85b81-default-rtdb.firebaseio.com",
            projectId: "hydrocarev1-85b81",
            storageBucket: "hydrocarev1-85b81.firebasestorage.app",
            messagingSenderId: "955201396609",
            appId: "1:955201396609:web:d37b3376d6f003b3ed5280"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const links = document.querySelectorAll('.nav-link[data-section]');
        const sections = document.querySelectorAll('.content-section');
        const pageTitle = document.getElementById('page-title');

        links.forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const target = link.getAttribute('data-section');
                links.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                sections.forEach(s => s.classList.remove('active'));
                document.getElementById(target).classList.add('active');
                pageTitle.innerText = link.innerText;
            };
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                const name = user.email.split('@')[0].toUpperCase();
                document.getElementById('user-display-name').innerText = name;
                document.getElementById('profile-name').innerText = name;
                startApp();
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('main-dashboard').style.display = 'none';
            }
        });

        document.getElementById('btnLogin').onclick = () => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            if(!e || !p) return alert("Isi email dan password!");
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("Gagal: " + err.message));
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);

        // Sidebar Toggle Logic
        const toggleBtn = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        toggleBtn.onclick = () => { sidebar.classList.add('open'); overlay.classList.add('active'); };
        overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('active'); };
        // Close sidebar when clicking a menu item on mobile
        document.querySelectorAll('.nav-link').forEach(l => l.addEventListener('click', () => { if(window.innerWidth < 992) { sidebar.classList.remove('open'); overlay.classList.remove('active'); } }));

        function startApp() {
            let r1, r2, modeActual;
            const up = (p, v) => set(ref(db, 'Greenhouse/' + p), v);

            function createChart(id, color) {
                return new Chart(document.getElementById(id), {
                    type: 'line',
                    data: { 
                        labels: Array(10).fill(''), 
                        datasets: [{ 
                            borderColor: color, borderWidth: 3,
                            data: Array(10).fill(0), tension: 0.4, 
                            fill: true, backgroundColor: color + '15', pointRadius: 0 
                        }] 
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { x: { display: false }, y: { display: false } } 
                    }
                });
            }

            const charts = { 
                t: createChart('cTemp', '#ef4444'), 
                h: createChart('cHum', '#6366f1'), 
                p: createChart('cPh', '#10b981'), 
                d: createChart('cTds', '#f59e0b')
            };

            // FUNGSI UNTUK MEMPERBARUI TABEL LOG AKTIVITAS SECARA REAL-TIME
            function listenToActivityLogs() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                
                const logPath = `Greenhouse/LogExcel/${year}/${month}/${day}`;
                
                onValue(ref(db, logPath), (snap) => {
                    const data = snap.val();
                    const tbody = document.getElementById('log-table-body');
                    
                    if (!data) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Belum ada log aktivitas hari ini.</td></tr>';
                        return;
                    }

                    // Ambil 10 data terbaru dan urutkan dari yang paling baru
                    const logs = Object.values(data).reverse().slice(0, 10); 
                    tbody.innerHTML = '';

                    logs.forEach(item => {
                        const relayStatus = item.Relay1 === 1 ? 
                            '<span class="badge bg-primary">AKTIF</span>' : 
                            '<span class="badge bg-light text-dark border">STANDBY</span>';
                            
                        tbody.innerHTML += `
                            <tr>
                                <td data-label="Waktu" class="fw-bold text-primary">${item.Waktu}</td>
                                <td data-label="Suhu">${item.Suhu_C}째C</td>
                                <td data-label="Lembap">${item.Lembap_Persen}%</td>
                                <td data-label="pH Air">${item.pH_Air}</td>
                                <td data-label="TDS (PPM)">${item.TDS_PPM}</td>
                                <td data-label="Pompa">${relayStatus}</td>
                            </tr>
                        `;
                    });
                });
            }

            onValue(ref(db, 'Greenhouse'), (snap) => {
                const d = snap.val(); if (!d) return;
                
                if (d.Sensor) {
                    const sensorData = [
                        { id: 'temp', val: d.Sensor.Temperatur },
                        { id: 'hum', val: d.Sensor.Kelembapan },
                        { id: 'ph', val: d.Sensor.pH ? d.Sensor.pH.toFixed(1) : "0.0" },
                        { id: 'tds', val: d.Sensor.TDS }
                    ];

                    sensorData.forEach(item => {
                        if(document.getElementById(item.id)) document.getElementById(item.id).innerText = item.val || 0;
                        if(document.getElementById('table-' + item.id)) document.getElementById('table-' + item.id).innerText = item.val || 0;
                    });

                    document.getElementById('waterL').innerText = d.Sensor.WaterLitres ? d.Sensor.WaterLitres.toFixed(1) : "0.0";
                    document.getElementById('waterPct').innerText = (d.Sensor.WaterLevel || 0) + "%";
                    document.getElementById('waterBar').style.width = (d.Sensor.WaterLevel || 0) + "%";
                    
                    const lvl = d.Sensor.WaterLevel || 0;
                    const wStatus = document.getElementById('waterStatus');
                    wStatus.innerText = lvl < 20 ? "KRITIS" : "NORMAL";
                    wStatus.className = lvl < 20 ? "badge bg-danger" : "badge bg-success";

                    const sV = [d.Sensor.Temperatur, d.Sensor.Kelembapan, d.Sensor.pH, d.Sensor.TDS];
                    Object.keys(charts).forEach((k, i) => {
                        charts[k].data.datasets[0].data.push(sV[i]);
                        charts[k].data.datasets[0].data.shift();
                        charts[k].update('none');
                    });
                }

                if (d.Control) {
                    modeActual = d.Control.Mode;
                    document.getElementById('mode').value = modeActual;
                    const ms = document.getElementById('modeStatus');
                    ms.innerText = "MODE: " + modeActual.toUpperCase();
                    ms.className = "badge-mode " + (modeActual === 'Auto' ? "bg-primary text-white" : "bg-warning text-dark shadow-sm");
                    
                    r1 = d.Control.ManualRelay1; r2 = d.Control.ManualRelay2;
                    document.getElementById('on1').value = d.Control.OnR1 || "00:00";
                    document.getElementById('off1').value = d.Control.OffR1 || "00:00";
                    document.getElementById('on2').value = d.Control.OnR2 || "00:00";
                    document.getElementById('off2').value = d.Control.OffR2 || "00:00";
                    document.getElementById('logInterval').value = d.Control.LogInterval || 5;                    
                    
                    document.getElementById('TeleActive').checked = d.Control.TeleActive || false;
                    document.getElementById('TeleToken').value = d.Control.TeleToken || "";
                    document.getElementById('TeleID').value = d.Control.TeleID || "";
                    document.getElementById('LimitTemp').value = d.Control.LimitTemp || 0;
                    document.getElementById('LimitHum').value = d.Control.LimitHum || 0;
                    document.getElementById('LimitTds').value = d.Control.LimitTds || 0;
                    document.getElementById('LimitWaterMin').value = d.Control.LimitWaterMin || 0;
                    document.getElementById('LimitPhMin').value = d.Control.LimitPhMin || 0;
                    document.getElementById('LimitPhMax').value = d.Control.LimitPhMax || 0;
                }

                if (d.Status) {
                    const updateRelayUI = (id, status) => {
                        const btn = document.getElementById(id);
                        btn.className = (status === 1) ? "btn-relay active-on" : "btn-relay";
                        btn.querySelector('.small').innerText = (status === 1) ? "Status: AKTIF" : "Status: STANDBY";
                    };
                    updateRelayUI('btn1', d.Status.Relay1);
                    updateRelayUI('btn2', d.Status.Relay2);
                }
            });

            // Jalankan listener log aktivitas
            listenToActivityLogs();

            const controlIds = [
                'on1','off1','on2','off2','mode','logInterval',
                'TeleActive', 'TeleToken', 'TeleID', 
                'LimitTemp', 'LimitHum', 'LimitTds', 'LimitWaterMin', 'LimitPhMin', 'LimitPhMax'
            ];

            controlIds.forEach(id => {
                const element = document.getElementById(id);
                if (!element) return;

                element.onchange = (e) => {
                    const target = e.target;
                    let v;

                    if (target.type === 'checkbox') {
                        v = target.checked;
                    } else if (target.type === 'number' || id.startsWith('Limit') || id === 'logInterval') {
                        v = parseFloat(target.value);
                    } else {
                        v = target.value;
                    }

                    let path = 'Control/' + id.charAt(0).toUpperCase() + id.slice(1);
                    if(id.includes('1') || id.includes('2')) {
                        path = 'Control/' + id.charAt(0).toUpperCase() + id.slice(1).toUpperCase();
                    }
                    up(path, v);
                };
            });

            document.getElementById('btn1').onclick = () => modeActual === 'Manual' ? up('Control/ManualRelay1', r1 === 1 ? 0 : 1) : alert("Ubah ke Mode Manual");
            document.getElementById('btn2').onclick = () => modeActual === 'Manual' ? up('Control/ManualRelay2', r2 === 1 ? 0 : 1) : alert("Ubah ke Mode Manual");

            document.getElementById('btnDownload').onclick = async () => {
                const dateVal = document.getElementById('downloadDate').value;
                const intervalVal = document.getElementById('logInterval').value;
                
                if (!dateVal) return alert("Pilih tanggal laporan!");

                const [year, month, day] = dateVal.split('-');
                const statusEl = document.getElementById('dlStatus');
                statusEl.style.display = 'block';

                try {
                    const logPath = `Greenhouse/LogExcel/${year}/${month}/${day}`;
                    const snap = await get(ref(db, logPath));
                    const data = snap.val();

                    if (!data) {
                        alert(`Data log untuk tanggal ${day}-${month}-${year} tidak ditemukan.`);
                        return;
                    }

                    const rows = [["Waktu", "Suhu (째C)", "Lembap (%)", "pH Air", "TDS (PPM)", "Water (%)", "Relay 1", "Relay 2"]];
                    
                    // Urutkan data berdasarkan waktu dan filter data yang tidak valid
                    const rawData = Object.values(data).sort((a, b) => (a.Waktu || "").localeCompare(b.Waktu || ""));
                    const filteredData = [];
                    const seenHours = new Set();

                    rawData.forEach(item => {
                        if (!item.Waktu) return;

                        if (intervalVal == "60") {
                            const hour = item.Waktu.split(':')[0];
                            if (!seenHours.has(hour)) {
                                filteredData.push(item);
                                seenHours.add(hour);
                            }
                        } else {
                            filteredData.push(item);
                        }
                    });

                    filteredData.forEach(i => {
                        rows.push([
                            i.Waktu, 
                            i.Suhu_C || 0, 
                            i.Lembap_Persen || 0, 
                            i.pH_Air || 0, 
                            i.TDS_PPM || 0, 
                            i.Water_Pct || 0, 
                            i.Relay1 || "-", 
                            i.Relay2 || "-"
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Log Sensor");
                    XLSX.writeFile(wb, `HydroCare_Report_${day}_${month}_${year}.xlsx`);
                } catch(e) { 
                    console.error(e);
                    alert("Error saat mengambil data.");
                } finally {
                    statusEl.style.display = 'none';
                }
            };

            // Set default date to local today (WIB/Local Time)
            const now = new Date();
            document.getElementById('downloadDate').value = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

            setInterval(() => {
                document.getElementById('current-time').innerText = new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' }) + " WIB";
            }, 1000);
        }
    </script>
</body>
</html>