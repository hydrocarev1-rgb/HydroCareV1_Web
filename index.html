<!DOCTYPE html>
<html lang="id">

<head>
    <title>HydroCare V1 | Smart Greenhouse Monitor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-soft: #ecfdf5;
            --bg-body: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --accent-blue: #3b82f6;
            --accent-amber: #f59e0b;
            --radius: 24px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: -0.01em;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05) !important;
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--primary) !important;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: none;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .sensor-val {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin: 12px 0;
        }

        .label-unit {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- MODERN RELAY BUTTONS --- */
        .btn-relay {
            height: 120px;
            font-weight: 700;
            border-radius: 20px;
            border: none;
            background: #f8fafc;
            color: var(--text-sub);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn-relay i { font-size: 1.8rem; margin-bottom: 8px; transition: transform 0.3s ease; }

        .btn-relay.active-on {
            background: linear-gradient(135deg, var(--primary), #059669) !important;
            color: white !important;
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
        }

        .btn-relay.active-on i { transform: scale(1.1) rotate(5deg); }

        .relay-status-dot {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: #cbd5e1;
            border-radius: 50%;
        }

        .active-on .relay-status-dot {
            background: #fff;
            box-shadow: 0 0 8px #fff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            70% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(0.95); opacity: 0; }
        }
        /* --------------------------- */

        .badge-mode {
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 0.9rem;
            background-color: #f8fafc;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 4px var(--primary-soft);
            border-color: var(--primary);
        }

        .chart-container {
            height: 70px;
            margin-top: 10px;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.05));
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--text-sub);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: "";
            height: 1px;
            background: #e2e8f0;
            flex-grow: 1;
        }

        .btn-download {
            background: var(--primary-soft);
            border: 2px dashed var(--primary);
            color: var(--primary);
            border-radius: var(--radius);
            padding: 30px 20px;
            transition: all 0.3s ease;
            text-align: center;
            cursor: pointer;
        }

        .btn-download:hover {
            background: var(--primary);
            color: white;
        }

        .progress { background-color: #e2e8f0; border-radius: 10px; overflow: hidden; }
    </style>
</head>

<body class="pb-5">
    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-leaf me-2"></i>HYDROCARE <span class="fw-light">V1</span>
            </a>
            <div class="time-display d-none d-md-block">
                <span class="badge bg-white text-dark border py-2 px-3 rounded-pill shadow-sm">
                    <i class="far fa-clock text-primary me-2"></i><span id="current-time" class="fw-bold text-uppercase" style="font-size: 0.8rem;">00:00:00 WIB</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4 align-items-center">
            <div class="col-6">
                <h2 class="fw-bold m-0" style="letter-spacing: -1px;">Dashboard</h2>
            </div>
            <div class="col-6 text-end">
                <span id="modeStatus" class="badge-mode bg-primary text-white text-uppercase">AUTO MODE</span>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="border-top: 4px solid #ef4444;">
                    <span class="label-unit"><i class="fas fa-thermometer-half me-1"></i> Temperatur</span>
                    <div class="sensor-val"><span id="temp">0</span><small class="fs-4 text-muted">°C</small></div>
                    <div class="chart-container"><canvas id="cTemp"></canvas></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="border-top: 4px solid #3b82f6;">
                    <span class="label-unit"><i class="fas fa-cloud-sun-rain me-1"></i> Kelembapan</span>
                    <div class="sensor-val"><span id="hum">0</span><small class="fs-4 text-muted">%</small></div>
                    <div class="chart-container"><canvas id="cHum"></canvas></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="border-top: 4px solid #10b981;">
                    <span class="label-unit"><i class="fas fa-vial me-1"></i> Tingkat pH</span>
                    <div class="sensor-val"><span id="ph">0.0</span></div>
                    <div class="chart-container"><canvas id="cPh"></canvas></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="border-top: 4px solid #f59e0b;">
                    <span class="label-unit"><i class="fas fa-flask me-1"></i> Nutrisi (TDS)</span>
                    <div class="sensor-val"><span id="tds">0</span><small class="fs-6 text-muted"> ppm</small></div>
                    <div class="chart-container"><canvas id="cTds"></canvas></div>
                </div>
            </div>
        </div>

        <div class="stat-card mb-5">
            <div class="row align-items-center">
                <div class="col-lg-3 border-end">
                    <span class="label-unit">Volume Air Tangki</span>
                    <div class="sensor-val text-primary mb-0"><span id="waterL">0.0</span><small class="fs-5"> L</small></div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small fw-bold text-secondary">Kapasitas: <span id="waterPct">0</span>%</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div id="waterBar" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9 ps-lg-4">
                    <span class="label-unit">Tren Level Air</span>
                    <div class="chart-container" style="height: 100px;"><canvas id="cWater"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="stat-card mb-4">
                    <div class="section-title text-uppercase">Sistem Penjadwalan</div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="p-3 border rounded-4 bg-light">
                                <label class="small fw-800 text-secondary mb-2 d-block">RELAY 1 (POMPA)</label>
                                <div class="d-flex gap-2">
                                    <input type="time" id="on1" class="form-control">
                                    <div class="align-self-center text-muted">-</div>
                                    <input type="time" id="off1" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 border rounded-4 bg-light">
                                <label class="small fw-800 text-secondary mb-2 d-block">RELAY 2 (KIPAS)</label>
                                <div class="d-flex gap-2">
                                    <input type="time" id="on2" class="form-control">
                                    <div class="align-self-center text-muted">-</div>
                                    <input type="time" id="off2" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mt-4">
                            <label class="fw-bold mb-2">Pilih Mode Operasi</label>
                            <select id="mode" class="form-select form-select-lg">
                                <option value="Auto">Otomatis (Berdasarkan Waktu & Sensor)</option>
                                <option value="Manual">Manual (Kontrol Sakelar Langsung)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="section-title text-uppercase">Ambang Batas & Notifikasi</div>
                    <div class="form-check form-switch mb-4 p-0 d-flex align-items-center">
                        <input class="form-check-input ms-0 me-3" type="checkbox" id="teleActive" style="width: 3.5rem; height: 1.75rem;">
                        <label class="form-check-label fw-bold" for="teleActive">Aktifkan Notifikasi Telegram</label>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="small fw-bold text-muted">MAX TEMP</label>
                            <div class="input-group">
                                <input type="number" id="limitTemp" class="form-control" step="0.1">
                                <span class="input-group-text">°C</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold text-muted">MIN pH</label>
                            <input type="number" id="limitPhMin" class="form-control" step="0.1">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold text-muted">MAX pH</label>
                            <input type="number" id="limitPhMax" class="form-control" step="0.1">
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted">BOT TOKEN TELEGRAM</label>
                            <input type="password" id="teleToken" class="form-control" placeholder="Hidden">
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted">CHAT ID</label>
                            <input type="text" id="teleID" class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="stat-card mb-4">
                    <div class="section-title text-uppercase">
                        <i class="fas fa-sliders-h me-2 text-primary"></i>Kontrol Manual
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <button id="btn1" class="btn-relay w-100 shadow-sm">
                                <div class="relay-status-dot"></div>
                                <i class="fas fa-tint"></i>
                                <span>AIR</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button id="btn2" class="btn-relay w-100 shadow-sm">
                                <div class="relay-status-dot"></div>
                                <i class="fas fa-fan"></i>
                                <span>KIPAS</span>
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 p-3 rounded-4 bg-light border-start border-4 border-warning">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            <p class="small text-muted mb-0">Aktifkan <b>Mode Manual</b> untuk menggunakan sakelar.</p>
                        </div>
                    </div>
                </div>

                <div class="stat-card text-center">
                    <div class="section-title text-uppercase">Export Data</div>
                    <div class="mb-4 text-start">
                        <label class="small fw-bold text-muted mb-2">INTERVAL LOGGING</label>
                        <select id="logInterval" class="form-select">
                            <option value="5">5 Menit</option>
                            <option value="15">15 Menit</option>
                            <option value="60">1 Jam</option>
                        </select>
                    </div>
                    <div id="btnDownload" class="btn-download">
                        <i class="fas fa-file-excel fa-2x mb-2"></i><br>
                        <span class="fw-800">UNDUH LAPORAN</span>
                    </div>
                    <div id="dlStatus" class="small mt-3 text-primary fw-bold" style="display:none;">
                        <span class="spinner-border spinner-border-sm me-2"></span>Memproses...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCscH1HT-y9QOeZ-nJtlu-suPMks5utEMw",
            authDomain: "hydrocarev1-85b81.firebaseapp.com",
            databaseURL: "https://hydrocarev1-85b81-default-rtdb.firebaseio.com",
            projectId: "hydrocarev1-85b81",
            storageBucket: "hydrocarev1-85b81.firebasestorage.app",
            messagingSenderId: "955201396609",
            appId: "1:955201396609:web:d37b3376d6f003b3ed5280",
            measurementId: "G-9ED7JEK25S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let r1, r2, modeActual;

        const up = (path, value) => {
            set(ref(db, 'Greenhouse/' + path), value);
        };

        function updateClock() {
            const now = new Date();
            const options = { timeZone: 'Asia/Jakarta', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('current-time').innerText = now.toLocaleTimeString('id-ID', options) + " WIB";
        }
        setInterval(updateClock, 1000);
        updateClock();

        function createChart(id, color) {
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: ['', '', '', '', '', '', '', '', '', ''], datasets: [{ borderColor: color, data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], tension: 0.4, fill: true, backgroundColor: color + '15', borderWidth: 2, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        const charts = {
            t: createChart('cTemp', '#ef4444'),
            h: createChart('cHum', '#3b82f6'),
            p: createChart('cPh', '#10b981'),
            d: createChart('cTds', '#f59e0b'),
            w: createChart('cWater', '#10b981')
        };

        onValue(ref(db, 'Greenhouse'), (snap) => {
            const d = snap.val();
            if (!d) return;

            if (d.Sensor) {
                document.getElementById('temp').innerText = d.Sensor.Temperatur || 0;
                document.getElementById('hum').innerText = d.Sensor.Kelembapan || 0;
                document.getElementById('ph').innerText = (d.Sensor.pH !== undefined) ? d.Sensor.pH.toFixed(1) : "0.0";
                document.getElementById('tds').innerText = d.Sensor.TDS || 0;
                
                const wPct = d.Sensor.WaterLevel || 0;
                const wLitres = (d.Sensor.WaterLitres !== undefined) ? d.Sensor.WaterLitres.toFixed(1) : "0.0";
                document.getElementById('waterL').innerText = wLitres;
                document.getElementById('waterPct').innerText = wPct;
                document.getElementById('waterBar').style.width = wPct + "%";

                const sensorVals = [d.Sensor.Temperatur || 0, d.Sensor.Kelembapan || 0, d.Sensor.pH || 0, d.Sensor.TDS || 0, wPct];
                Object.keys(charts).forEach((k, i) => {
                    charts[k].data.datasets[0].data.push(sensorVals[i]);
                    charts[k].data.datasets[0].data.shift();
                    charts[k].update('none');
                });
            }

            if (d.Control) {
                modeActual = d.Control.Mode || "Auto";
                document.getElementById('mode').value = modeActual;
                const modeBadge = document.getElementById('modeStatus');
                modeBadge.innerText = modeActual.toUpperCase() + " MODE";
                modeBadge.style.backgroundColor = (modeActual === 'Auto') ? '#10b981' : '#f59e0b';

                r1 = d.Control.ManualRelay1; r2 = d.Control.ManualRelay2;
                document.getElementById('on1').value = d.Control.OnR1 || "08:00";
                document.getElementById('off1').value = d.Control.OffR1 || "17:00";
                document.getElementById('on2').value = d.Control.OnR2 || "18:00";
                document.getElementById('off2').value = d.Control.OffR2 || "06:00";
                document.getElementById('logInterval').value = d.Control.LogInterval || 5;
                document.getElementById('teleActive').checked = d.Control.TeleActive || false;
                document.getElementById('teleToken').value = d.Control.TeleToken || "";
                document.getElementById('teleID').value = d.Control.TeleID || "";
                document.getElementById('limitTemp').value = d.Control.LimitTemp || 35.0;
                document.getElementById('limitPhMin').value = d.Control.LimitPhMin || 5.5;
                document.getElementById('limitPhMax').value = d.Control.LimitPhMax || 7.5;
            }

            if (d.Status) {
                document.getElementById('btn1').className = (d.Status.Relay1 === 1) ? "btn-relay active-on w-100 shadow-sm" : "btn-relay w-100 shadow-sm";
                document.getElementById('btn2').className = (d.Status.Relay2 === 1) ? "btn-relay active-on w-100 shadow-sm" : "btn-relay w-100 shadow-sm";
            }
        });

        const handleRelayManual = (relayKey, currentVal) => {
            if (modeActual !== 'Manual') {
                alert('Peringatan: Aktifkan "Mode Manual" untuk mengontrol sakelar ini secara langsung.');
                return;
            }
            up('Control/' + relayKey, currentVal === 1 ? 0 : 1);
        };

        document.getElementById('btn1').onclick = () => handleRelayManual('ManualRelay1', r1);
        document.getElementById('btn2').onclick = () => handleRelayManual('ManualRelay2', r2);

        const inputs = [
            { id: 'on1', path: 'Control/OnR1' }, { id: 'off1', path: 'Control/OffR1' },
            { id: 'on2', path: 'Control/OnR2' }, { id: 'off2', path: 'Control/OffR2' },
            { id: 'mode', path: 'Control/Mode' }, { id: 'logInterval', path: 'Control/LogInterval', type: 'int' },
            { id: 'teleActive', path: 'Control/TeleActive', type: 'bool' },
            { id: 'limitTemp', path: 'Control/LimitTemp', type: 'float' },
            { id: 'limitPhMin', path: 'Control/LimitPhMin', type: 'float' },
            { id: 'limitPhMax', path: 'Control/LimitPhMax', type: 'float' },
            { id: 'teleToken', path: 'Control/TeleToken' }, { id: 'teleID', path: 'Control/TeleID' }
        ];

        inputs.forEach(item => {
            const el = document.getElementById(item.id);
            el.onchange = () => {
                let val = el.value;
                if (item.type === 'int') val = parseInt(val);
                if (item.type === 'float') val = parseFloat(val);
                if (item.type === 'bool') val = el.checked;
                up(item.path, val);
            };
        });

        document.getElementById('btnDownload').onclick = async () => {
            const statusEl = document.getElementById('dlStatus');
            statusEl.style.display = 'block';
            try {
                const snapshot = await get(ref(db, 'Greenhouse/LogExcel'));
                const data = snapshot.val();
                if (!data) { alert("Data riwayat kosong!"); statusEl.style.display = 'none'; return; }

                const now = new Date();
                const excelRows = [
                    ["DATA LAPORAN HYDROCARE V1"],
                    ["Waktu Unduh: " + now.toLocaleString()],
                    [],
                    ["Waktu", "Suhu (°C)", "Kelembapan (%)", "pH Air", "Nutrisi (TDS)", "Level Air (%)"]
                ];

                Object.keys(data).forEach(key => {
                    const item = data[key];
                    excelRows.push([item.Waktu || "-", item.Suhu_C || 0, item.Lembap_Persen || 0, item.pH_Air || 0, item.TDS_PPM || 0, item.Water_Pct || 0]);
                });

                const worksheet = XLSX.utils.aoa_to_sheet(excelRows);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan");
                XLSX.writeFile(workbook, "HydroCare_Log_" + now.toISOString().slice(0, 10) + ".xlsx");
                statusEl.style.display = 'none';
            } catch (err) { console.error(err); statusEl.style.display = 'none'; }
        };
    </script>
</body>

</html>